(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{137:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return c})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return p})),a.d(t,"default",(function(){return u}));var n=a(2),o=a(6),r=(a(0),a(144)),i=a(146),c={id:"micResSerRedAndKaf",title:"Java Micronaut REST Server with Redis and Kafka"},l={id:"javMicExa/micResSerRedAndKaf",isDocsHomePage:!1,title:"Java Micronaut REST Server with Redis and Kafka",description:"\ud83d\udd53 40 minutes",source:"@site/docs\\javMicExa\\javaMicronautRestServerWithRedisAndKafka.mdx",permalink:"/code_now/docs/javMicExa/micResSerRedAndKaf",editUrl:"https://github.com/VitSestak/code_now/docs/javMicExa/javaMicronautRestServerWithRedisAndKafka.mdx",sidebar:"Docs",previous:{title:"Docs intro",permalink:"/code_now/docs/"},next:{title:"Java Micronaut REST Server with PostgreSQL",permalink:"/code_now/docs/javMicExa/micResSerPosSQL"}},p=[{value:"What you will learn",id:"what-you-will-learn",children:[]},{value:"Project source",id:"project-source",children:[]},{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Steps",id:"steps",children:[]},{value:"What\u2019s next?",id:"whats-next",children:[]}],s={rightToc:p};function u(e){var t=e.components,a=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(n.a)({},s,a,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"\ud83d\udd53 40 minutes"),Object(r.b)("h2",{id:"what-you-will-learn"},"What you will learn"),Object(r.b)("p",null,"How to setup your application for : "),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"connecting to Redis,"),Object(r.b)("li",{parentName:"ul"},"connecting to Kafka and publishing messages to its topic,"),Object(r.b)("li",{parentName:"ul"},"getting data from REST API, "),Object(r.b)("li",{parentName:"ul"},"providing data to REST API. ")),Object(r.b)("p",null,"In this tutorial, we will create a simple java component with the Java Micronaut scaffolder. We want to expose a single REST endpoint for getting user authorization roles. As roles are stored in Redis key-value store, we need a client configuration for our component. Any access to information about user roles should be logged in a Kafka topic, so we need a Kafka client configuration too."),Object(r.b)("img",{alt:"clientAuthorizationService",src:Object(i.a)("img/javMicExa/javaMicronautRestServerWithRedisAndKafka/ClientAuthorizationService.png")}),Object(r.b)("h2",{id:"project-source"},"Project source"),Object(r.b)("p",null,"This example project can be cloned from: ",Object(r.b)("inlineCode",{parentName:"p"},"git@gitlab.factory.innobank.codenow.com:innobank/client-authorization-service.git")),Object(r.b)("h2",{id:"prerequisites"},"Prerequisites"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"Prepare your local development environment for CodeNOW with Micronaut. ",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Follow the tutorial instructions in the ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/locDevWitCodNow/locDev/"}),"Java Micronaut Local Development")," tutorial."))),Object(r.b)("li",{parentName:"ul"},"Run Kafka and Redis locally. ",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Use docker compose as described in the section ",Object(r.b)("em",{parentName:"li"},"Docker compose and third-party tools")," of the ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/locDevWitCodNow/locDev/"}),"Java Micronaut Local Development")," tutorial. "))),Object(r.b)("li",{parentName:"ul"},"Create a new component",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"For details see the section ",Object(r.b)("em",{parentName:"li"},"Prerequisites")," of the ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/locDevWitCodNow/locDev/"}),"Java Micronaut Local Development")," tutorial.")))),Object(r.b)("h2",{id:"steps"},"Steps"),Object(r.b)("p",null,"Open your IDE, import created component and start coding:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Define message payload. Here is an example of UserAuthorizationResponse, which is a simple POJO with user roles:"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"generate getters and setters with your IDE"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),"01  package io.codenow.client.authorization.service.model;    \n02\n03  import java.util.Set;\n04\n05  public class UserAuthorizationResponse {\n06\n07          private Set<String> roles;\n08\n09  }\n")))))),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Next prepare the configuration for the kafka logging client:"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Go to the Kafka administration console (",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"http://localhost:9000"}),"http://localhost:9000")," if using kafdrop from our Local development manual) and create a new topic ",Object(r.b)("strong",{parentName:"p"},"client-logging"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Add maven dependency to your pom.xml"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),"01  <dependency>\n02    <groupId>io.micronaut.kafka</groupId>\n03    <artifactId>micronaut-kafka</artifactId>\n04    <version>2.0.0</version>\n05  </dependency>\n")))))),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"For more details about micronaut-kafka, see: ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://micronaut-projects.github.io/micronaut-kafka/latest/guide/"}),"https://micronaut-projects.github.io/micronaut-kafka/latest/guide/"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Now use the code below to create a logging client:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),"01  package io.codenow.client.authorization.service.logging;\n02  \n03  import io.micronaut.configuration.kafka.annotation.KafkaClient;\n04  import io.micronaut.configuration.kafka.annotation.KafkaKey;\n05  import io.micronaut.configuration.kafka.annotation.Topic;\n06 \n07  @KafkaClient\n08  public interface LoggingClient {\n09 \n10     void log(@Topic String topic, @KafkaKey String key, String msg);\n11  }\n"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Next prepare the configuration for the Redis client:"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"For more details about Micronaut Redis, see: ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://micronaut-projects.github.io/micronaut-redis/snapshot/guide/"}),"https://micronaut-projects.github.io/micronaut-redis/snapshot/guide/")," ")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Add maven dependency to your pom.xml"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),"01  <dependency>\n02    <groupId>io.micronaut.redis</groupId>\n03    <artifactId>micronaut-redis-lettuce</artifactId>\n04    <version>2.0.0</version>\n05  </dependency>\n"))))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Create a new controller and put all the parts together"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"For more details about Micronaut controller, see:  ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.micronaut.io/latest/guide/index.html#httpServer"}),"https://docs.micronaut.io/latest/guide/index.html#httpServer")),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),'01  package io.codenow.client.authorization.service.controller;\n02 \n03 \n04  import java.util.List;\n05  import java.util.TreeSet; \n06 \n07  import javax.inject.Inject;\n08 \n09  import io.codenow.client.authorization.service.logging.LoggingClient;\n10  import io.codenow.client.authorization.service.model.UserAuthorizationResponse;\n11  import io.lettuce.core.api.StatefulRedisConnection;\n12  import io.lettuce.core.api.sync.RedisCommands;\n13  import io.micronaut.context.annotation.Value;\n14  import io.micronaut.http.annotation.Consumes;\n15  import io.micronaut.http.annotation.Controller;\n16  import io.micronaut.http.annotation.Get;\n17  import io.micronaut.http.annotation.PathVariable;\n18  import io.micronaut.http.annotation.Produces;\n19  import io.micronaut.validation.Validated;\n20  import io.reactivex.Single; \n21 \n22  /**\n23   * UserAuthorizationController.\n24   */\n25  @Validated\n26  @Controller("/user")\n27  public class UserAuthorizationController {\n28     \n29      @Inject private StatefulRedisConnection<String, String> connection;\n30      @Inject private LoggingClient loggingClient;\n31      @Value("${kafka.topic.name}") private String kafkaTopicName;\n32      @Value("${kafka.topic.key}") private String kafkaTopicKey;\n33 \n34      @Get("/{username}")\n35      @Produces\n36      @Consumes\n37      public Single<UserAuthorizationResponse> greeting(@PathVariable String username) {\n38      \n39       loggingClient.log(kafkaTopicName, kafkaTopicKey, username);\n40 \n41          final UserAuthorizationResponse response = new UserAuthorizationResponse();\n42          RedisCommands<String, String> commands = connection.sync();\n43          List<String> privileges = commands.lrange(username, 0L, 1000L);\n44          response.setRoles(new TreeSet<>(privileges));\n45      \n46          return Single.just(response);\n47      }\n48  }\n'))))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Last but not least, append the configuration for Kafka and Redis to ",Object(r.b)("em",{parentName:"p"},"config/application.yaml")),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Note that this configuration depends on your local development setup for Kafka and Redis and can be different case-by-case")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Make sure you follow yaml syntax (especially whitespaces)"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(n.a)({parentName:"pre"},{className:"language-java"}),"01  redis:\n02    uri: redis://localhost:6379\n03 \n04  kafka:\n05    bootstrap:\n06      servers: localhost:29092\n07    topic:\n08      name: client-logging\n09      key: client-authorization-service\n"))))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Do not forget to change the swagger.yaml. Check it in the example project: ",Object(r.b)("em",{parentName:"p"},"src/main/resources/META-INF/swagger/swagger.yaml"))),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},"Try to build and run application in your IDE. After startup, you should be able to access your new controller\u2019s swagger: ",Object(r.b)("strong",{parentName:"p"},Object(r.b)("a",Object(n.a)({parentName:"strong"},{href:"http://localhost:8080/swagger/index.html"}),"http://localhost:8080/swagger/index.html"))),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"For correct setup, check Readme.md in project root or see tutorial ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/locDevWitCodNow/locDev/"}),"Java Micronaut Local Development"),", section ",Object(r.b)("em",{parentName:"li"},"Prepare local development IDE"),"  ")))),Object(r.b)("img",{alt:"ClientAuthorizationServiceSwagger",src:Object(i.a)("img/javMicExa/javaMicronautRestServerWithRedisAndKafka/clientAuthorizationService_swagger.png")}),Object(r.b)("h2",{id:"whats-next"},"What\u2019s next?"),Object(r.b)("p",null,"If your code works in the local development, you are ready to push your changes to GIT and try to build and deploy your new component version to the CodeNOW environment. For more information see ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://vitsestak.github.io/code_now/docs/admMan/depApp/"}),"Application Deployment")," and ",Object(r.b)("a",Object(n.a)({parentName:"p"},{href:"https://vitsestak.github.io/code_now/docs/admMan/depMon/"}),"Monitoring"),", just make sure to ",Object(r.b)("strong",{parentName:"p"},"change the application.yaml properties from the local to the production setup.")),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"check ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/manComAdm/getNewRed"}),"Get New Redis")," and ",Object(r.b)("a",Object(n.a)({parentName:"li"},{href:"https://vitsestak.github.io/code_now/docs/manComAdm/getNewApaKaf"}),"Get New Apache Kafka")," for setup in the CodeNOW environment")))}u.isMDXComponent=!0},144:function(e,t,a){"use strict";a.d(t,"a",(function(){return u})),a.d(t,"b",(function(){return d}));var n=a(0),o=a.n(n);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var p=o.a.createContext({}),s=function(e){var t=o.a.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},u=function(e){var t=s(e.components);return o.a.createElement(p.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return o.a.createElement(o.a.Fragment,{},t)}},m=o.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(a),m=n,d=u["".concat(i,".").concat(m)]||u[m]||b[m]||r;return a?o.a.createElement(d,c(c({ref:t},p),{},{components:a})):o.a.createElement(d,c({ref:t},p))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,i=new Array(r);i[0]=m;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:n,i[1]=c;for(var p=2;p<r;p++)i[p]=a[p];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"},145:function(e,t,a){"use strict";var n=a(0),o=a(35);t.a=function(){return Object(n.useContext)(o.a)}},146:function(e,t,a){"use strict";a.d(t,"a",(function(){return r}));var n=a(145),o=a(147);function r(e,{forcePrependBaseUrl:t=!1,absolute:a=!1}={}){const{siteConfig:{baseUrl:r="/",url:i}={}}=Object(n.a)();if(!e)return e;if(t)return r+e;if(!Object(o.a)(e))return e;const c=r+e.replace(/^\//,"");return a?i+c:c}},147:function(e,t,a){"use strict";function n(e){return!1===/^(https?:|\/\/|mailto:|tel:)/.test(e)}a.d(t,"a",(function(){return n}))}}]);